<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Misturador Acrilico Pro - Studio v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #09090b; color: #eee; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { height: 6px; width: 6px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        .checkered-bg {
            background-color: #121212;
            background-image: linear-gradient(45deg, #1a1a1a 25%, transparent 25%), linear-gradient(-45deg, #1a1a1a 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #1a1a1a 75%), linear-gradient(-45deg, transparent 75%, #1a1a1a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        #magnifier { border-radius: 50%; overflow: hidden; box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5), 0 10px 30px rgba(0,0,0,0.8); pointer-events: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-black">

    <header class="bg-[#09090b] border-b border-[#27272a] h-16 md:h-20 flex-none z-20 flex items-center px-2 md:px-4 shadow-md relative">
        <div class="flex items-center gap-2 md:gap-3 w-auto md:w-64 border-r border-[#27272a] mr-2 md:mr-4 pr-2 md:pr-4 h-10">
            <div class="bg-orange-600/20 p-1.5 rounded-lg flex-shrink-0"><i data-lucide="palette" class="w-5 h-5 text-orange-500"></i></div>
            <div class="hidden sm:block">
                <h1 class="text-xs font-bold text-gray-200 uppercase tracking-wider">Catálogo Master</h1>
                <span class="text-[10px] text-gray-500">Tintas a Acrilico</span>
            </div>
        </div>
        <div id="catalogList" class="flex-1 flex gap-1 overflow-x-auto pb-1 items-center h-12 px-2 no-scrollbar"></div>
        <div class="w-32 md:w-48 ml-2 md:ml-4 pl-2 md:pl-4 border-l border-[#27272a]">
            <div class="relative">
                <i data-lucide="search" class="absolute left-2 top-2 w-3 h-3 text-gray-500"></i>
                <input type="text" id="searchInput" class="bg-[#18181b] border border-[#27272a] text-gray-300 text-[10px] rounded-full focus:ring-1 focus:ring-orange-500 block w-full pl-7 p-1.5 placeholder-gray-600" placeholder="Filtrar...">
            </div>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <section class="flex-1 bg-[#050505] relative flex flex-col items-center justify-center overflow-hidden md:border-r border-[#27272a]">
            <div class="absolute top-4 left-4 z-10">
                <input type="file" id="imageInput" accept="image/*" class="hidden">
                <button onclick="document.getElementById('imageInput').click()" class="bg-black/60 hover:bg-orange-600/90 text-white px-3 py-2 rounded-lg text-xs font-medium backdrop-blur-md border border-white/10 transition flex items-center gap-2 shadow-lg">
                    <i data-lucide="image-plus" class="w-4 h-4"></i><span class="hidden sm:inline">Carregar Imagem</span><span class="sm:hidden">Carregar</span>
                </button>
            </div>
            <div id="canvasContainer" class="w-full h-full flex items-center justify-center cursor-crosshair relative checkered-bg touch-none">
                <div id="emptyState" class="text-center opacity-40"><i data-lucide="image" class="w-12 h-12 md:w-16 md:h-16 text-gray-500 mx-auto mb-2"></i><p class="text-gray-500 text-sm">Carregar imagem</p></div>
                <canvas id="imageCanvas" class="hidden shadow-2xl max-w-full max-h-full"></canvas>
                <div id="magnifier" class="fixed w-24 h-24 md:w-32 md:h-32 hidden z-50 bg-black border border-gray-700">
                    <canvas id="zoomCanvas" width="128" height="128"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center"><div class="w-1 h-1 bg-red-500 shadow-[0_0_2px_white]"></div></div>
                </div>
            </div>
        </section>

        <section class="w-full h-[45vh] md:h-full md:w-[400px] flex-none bg-[#0c0c0e] flex flex-col border-t md:border-t-0 md:border-l border-[#27272a] shadow-2xl z-10">
            <div class="flex-1 overflow-y-auto p-3 md:p-5 space-y-4 md:space-y-6">
                
                <div class="bg-[#141417] rounded-xl border border-[#27272a] p-3 md:p-4 shadow-sm">
                    <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i data-lucide="scan-eye" class="w-3 h-3 text-orange-500"></i> Análise</h3>
                    <div class="flex items-center justify-between gap-3 mb-3">
                        <div class="text-center flex-1">
                            <div id="targetSwatch" class="w-full h-10 md:h-12 rounded border border-gray-700 bg-black shadow-inner mb-1"></div>
                            <span class="text-[9px] text-gray-500 uppercase">Alvo</span>
                        </div>
                        <i data-lucide="arrow-right" class="text-gray-700 w-4 h-4"></i>
                        <div class="text-center flex-1 relative">
                            <div id="mixedSwatch" class="w-full h-10 md:h-12 rounded border border-gray-700 bg-black shadow-inner mb-1"></div>
                            <span class="text-[9px] text-gray-500 uppercase">Mistura</span>
                            <div id="accuracyBadge" class="absolute -top-2 -right-1 bg-gray-800 text-gray-400 text-[9px] px-1.5 py-0.5 rounded border border-gray-700 font-bold">0%</div>
                        </div>
                    </div>
                    <div class="bg-[#09090b] rounded p-2 md:p-3 border border-[#27272a]">
                        <div class="flex justify-between items-center mb-2 pb-2 border-b border-[#27272a]">
                            <h4 class="text-[10px] font-bold text-gray-300 uppercase">Receita</h4>
                            <button onclick="saveCurrentRecipe()" id="btnSave" class="text-[9px] bg-zinc-800 hover:bg-zinc-700 text-gray-300 px-2 py-0.5 rounded border border-zinc-700 disabled:opacity-50" disabled>Salvar</button>
                        </div>
                        <div id="recipeOutput" class="space-y-1.5 min-h-[40px] flex flex-col justify-center"><p class="text-gray-600 italic text-xs text-center">Toque na imagem.</p></div>
                    </div>
                </div>

                <div id="idealMatchContainer" class="hidden relative group">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-yellow-600/20 to-orange-600/20 rounded-xl blur-sm opacity-50"></div>
                    <div class="relative bg-[#141417] rounded-xl p-3 md:p-4 border border-yellow-500/20">
                        <div class="flex justify-between items-start mb-2">
                            <h5 class="text-[10px] font-bold text-yellow-500 uppercase tracking-wider flex items-center gap-1.5"><i data-lucide="sparkles" class="w-3 h-3"></i> Precisão Máxima</h5>
                            <div id="idealSwatch" class="w-6 h-6 rounded border border-yellow-500/30 bg-black"></div>
                        </div>
                        <div id="idealMatchContent" class="space-y-1 text-xs"></div>
                    </div>
                </div>

                <div class="space-y-4 pb-4">
                    <div>
                        <div class="flex justify-between items-center mb-2 px-1">
                            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2"><i data-lucide="box" class="w-3 h-3"></i> Minha Bancada</h3>
                            <button onclick="clearBench()" class="text-[10px] text-red-400 hover:text-red-300">Limpar</button>
                        </div>
                        <div id="myBench" class="grid grid-cols-1 gap-1.5 max-h-32 overflow-y-auto"></div>
                    </div>
                    
                    <div>
                        <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 flex items-center gap-2 px-1"><i data-lucide="bookmark" class="w-3 h-3"></i> Salvas</h3>
                        <div id="savedList" class="space-y-2 max-h-32 overflow-y-auto pr-1"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // --- DADOS ---
        const PAINT_COLORS = [
            { id: '319', name: 'Branco de Titânio', hex: '#FEFEFE' }, { id: '310', name: 'Cor de Carne Clara', hex: '#FBEFD5' },
            { id: '326', name: 'Amarelo Pêssego', hex: '#FAD6A5' }, { id: '342', name: 'Amarelo Nápoles', hex: '#FFDB58' },
            { id: '304', name: 'Amarelo Nápoles Carne', hex: '#F5D0A9' }, { id: '323', name: 'Amarelo Limão', hex: '#F9F228' },
            { id: '340', name: 'A. Cádmio Claro', hex: '#FFDF00' }, { id: '324', name: 'Amarelo de Cádmio', hex: '#FFC000' },
            { id: '302', name: 'Amarelo Escuro', hex: '#FFAB00' }, { id: '339', name: 'Amarelo Indiano', hex: '#E3A857' },
            { id: '360', name: 'Amarelo Ocre', hex: '#C5962B' }, { id: '341', name: 'A. Cádmio Escuro', hex: '#E68A00' },
            { id: '325', name: 'Laranja de Cádmio', hex: '#FF7518' }, { id: '335', name: 'Laca Orquídea', hex: '#D48BB6' },
            { id: '316', name: 'Rosa Escuro', hex: '#C74673' }, { id: '315', name: 'Magenta', hex: '#C51D68' },
            { id: '366', name: 'Vermelho Veneza', hex: '#9E3C32' }, { id: '343', name: 'V. Cádmio Claro', hex: '#E34234' },
            { id: '312', name: 'Vermelho de Cádmio', hex: '#D3212D' }, { id: '350', name: 'Vermelho Claro', hex: '#D9381E' },
            { id: '344', name: 'V. Cádmio Escuro', hex: '#9E1B32' }, { id: '328', name: 'Laca Gerânio', hex: '#D62B45' },
            { id: '379', name: 'Carmim', hex: '#960018' }, { id: '346', name: 'Alizarin Crimson', hex: '#781F27' },
            { id: '321', name: 'Violeta Cobalto', hex: '#7866B0' }, { id: '330', name: 'Violeta Perm. Escuro', hex: '#4B2758' },
            { id: '306', name: 'Azul Hortênsia', hex: '#9FB6CD' }, { id: '363', name: 'Azul Turquesa', hex: '#009DC4' },
            { id: '347', name: 'Azul Cerúleo', hex: '#0077BE' }, { id: '308', name: 'Azul Cobalto', hex: '#0047AB' },
            { id: '348', name: 'Ultramar Claro', hex: '#4666FF' }, { id: '305', name: 'Azul Ftalocianina', hex: '#002366' },
            { id: '331', name: 'Azul da Prússia', hex: '#003153' }, { id: '364', name: 'Verde Inglês nº 5', hex: '#2E8B57' },
            { id: '322', name: 'Verde Musgo', hex: '#4A5D23' }, { id: '332', name: 'Verde Perm. Escuro', hex: '#00563B' },
            { id: '334', name: 'Verde Oliva', hex: '#6B8E23' }, { id: '354', name: 'Terra Verde', hex: '#6E7F5E' },
            { id: '353', name: 'Verde Vessie', hex: '#395D33' }, { id: '365', name: 'Verde de Hooker', hex: '#3B533E' },
            { id: '336', name: 'Terra de Siena Nat.', hex: '#A0522D' }, { id: '357', name: 'T. Siena Queimada', hex: '#8A3324' },
            { id: '355', name: 'Sombra Natural', hex: '#5C4033' }, { id: '337', name: 'Marrom Van Dyck', hex: '#45322E' },
            { id: '356', name: 'Sombra Queimada', hex: '#3D2B1F' }, { id: '396', name: 'Sépia', hex: '#2F241E' },
            { id: '311', name: 'Gris Neutro', hex: '#B0B0B0' }, { id: '399', name: 'Gris de Payne', hex: '#536872' },
            { id: '320', name: 'Preto', hex: '#1C1C1C' }
        ];

        let benchColors = [], savedRecipes = [], targetRGB = { r: 0, g: 0, b: 0 }, currentTargetHex = null, currentImageObject = null;
        let imgState = { x: 0, y: 0, w: 0, h: 0, scale: 1 };

        const catalogList = document.getElementById('catalogList'), myBench = document.getElementById('myBench'), imageCanvas = document.getElementById('imageCanvas');
        const canvasContainer = document.getElementById('canvasContainer'), zoomCanvas = document.getElementById('zoomCanvas'), magnifier = document.getElementById('magnifier');
        const ctx = imageCanvas.getContext('2d'), zoomCtx = zoomCanvas.getContext('2d'), savedList = document.getElementById('savedList');

        // --- INIT & UTILS ---
        function init() {
            renderCatalog(); loadBenchState(); loadSavedRecipes();
            window.addEventListener('resize', () => { if (currentImageObject) drawImageOnCanvas(); });
            lucide.createIcons();
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
            return {r,g,b};
        }
        function rgbToHex(r, g, b) { return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase(); }
        function dist(c1, c2) { return Math.sqrt(Math.pow(c1.r - c2.r, 2) + Math.pow(c1.g - c2.g, 2) + Math.pow(c1.b - c2.b, 2)); }

        // --- RENDERIZADORES ---
        function renderCatalog(filter = '') {
            const filtered = PAINT_COLORS.filter(c => c.name.toLowerCase().includes(filter) || c.id.includes(filter));
            catalogList.innerHTML = filtered.map(c => `<div onclick="addToBench('${c.id}')" class="flex-shrink-0 w-8 h-8 rounded-full border-2 border-[#333] hover:border-orange-500 cursor-pointer transition-all active:scale-95" style="background-color: ${c.hex}" title="${c.name}"></div>`).join('');
        }

        function renderBench() {
            const emptyHTML = `<div class="text-center py-4 border border-dashed border-[#27272a] rounded-lg bg-[#09090b]"><i data-lucide="arrow-up" class="w-4 h-4 text-gray-600 mx-auto mb-1"></i><p class="text-[10px] text-gray-500">Adicione tintas</p></div>`;
            if (benchColors.length === 0) { myBench.innerHTML = emptyHTML; } 
            else {
                myBench.innerHTML = benchColors.map(c => `<div class="flex items-center justify-between bg-[#141417] p-2 rounded border border-[#27272a] group"><div class="flex items-center gap-2 overflow-hidden"><div class="w-4 h-4 rounded-full border border-gray-600 flex-shrink-0" style="background-color: ${c.hex}"></div><span class="text-[10px] text-gray-400 truncate w-32">${c.name}</span></div><button onclick="removeFromBench('${c.id}')" class="text-gray-600 hover:text-red-400 md:opacity-0 group-hover:opacity-100 p-1"><i data-lucide="x" class="w-3 h-3"></i></button></div>`).join('');
            }
            lucide.createIcons();
            if (targetRGB.r + targetRGB.g + targetRGB.b > 0) calculateMixture();
        }

        // --- LÓGICA DE BANCADA ---
        window.addToBench = (id) => { if (!benchColors.find(c => c.id === id)) { benchColors.push(PAINT_COLORS.find(c => c.id === id)); saveBenchState(); renderBench(); } };
        window.removeFromBench = (id) => { benchColors = benchColors.filter(c => c.id !== id); saveBenchState(); renderBench(); };
        window.clearBench = () => { benchColors = []; saveBenchState(); renderBench(); };
        function saveBenchState() { localStorage.setItem('oil_bench_v3', JSON.stringify(benchColors.map(c => c.id))); }
        function loadBenchState() { const s = localStorage.getItem('oil_bench_v3'); if (s) { try { const ids = JSON.parse(s); benchColors = PAINT_COLORS.filter(c => ids.includes(c.id)); } catch(e){} } renderBench(); }

        // --- ALGORITMO DE MISTURA ---
        function findBestMix(colors, target) {
            let best = { d: Infinity, recipe: [], res: { r: 0, g: 0, b: 0 } };
            colors.forEach(c => { const rgb = hexToRgb(c.hex); const d = dist(target, rgb); if (d < best.d) best = { d, recipe: [{ c, p: 100 }], res: rgb }; });
            const sorted = [...colors].sort((a,b) => dist(target, hexToRgb(a.hex)) - dist(target, hexToRgb(b.hex))).slice(0, 4);
            if (sorted.length > 1) {
                for (let w1=0; w1<=10; w1++) {
                    for (let w2=0; w2<=(10-w1); w2++) {
                        for (let w3=0; w3<=(10-w1-w2); w3++) {
                            let w4 = 10-w1-w2-w3;
                            let ws = [w1/10, w2/10, w3/10, w4/10], mix = {r:0,g:0,b:0}, rec = [];
                            ws.forEach((w, i) => { if (w > 0 && sorted[i]) { const rgb = hexToRgb(sorted[i].hex); mix.r += Math.pow(rgb.r, 2)*w; mix.g += Math.pow(rgb.g, 2)*w; mix.b += Math.pow(rgb.b, 2)*w; rec.push({c: sorted[i], p: w*100}); } });
                            mix.r = Math.sqrt(mix.r); mix.g = Math.sqrt(mix.g); mix.b = Math.sqrt(mix.b);
                            const d = dist(target, mix); if (d < best.d) best = { d, recipe: rec, res: mix };
                        }
                    }
                }
            }
            return best;
        }

        function renderBenchResult(m) {
            const hex = rgbToHex(Math.round(m.res.r), Math.round(m.res.g), Math.round(m.res.b));
            document.getElementById('mixedSwatch').style.backgroundColor = hex;
            const acc = Math.max(0, Math.round((1 - (m.d / 150)) * 100));
            const b = document.getElementById('accuracyBadge');
            b.innerText = `${acc}%`;
            b.className = `absolute -top-2 -right-1 text-[9px] px-1.5 py-0.5 rounded border font-bold ${acc > 85 ? 'bg-green-900/80 text-green-200 border-green-700' : acc > 60 ? 'bg-yellow-900/80 text-yellow-200 border-yellow-700' : 'bg-red-900/80 text-red-200 border-red-700'}`;
            document.getElementById('recipeOutput').innerHTML = m.recipe.map(i => `<div class="flex justify-between items-center bg-[#18181b] p-1.5 rounded border border-[#27272a]"><div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${i.c.hex}"></div><span class="text-gray-300 truncate w-32 text-[11px]">${i.c.name}</span></div><span class="font-mono text-orange-400 font-bold text-[11px]">${i.p.toFixed(0)}%</span></div>`).join('');
        }

        function renderIdealResult(m) {
            const container = document.getElementById('idealMatchContainer'), content = document.getElementById('idealMatchContent'), swatch = document.getElementById('idealSwatch');
            container.classList.remove('hidden');
            const hex = rgbToHex(Math.round(m.res.r), Math.round(m.res.g), Math.round(m.res.b));
            swatch.style.backgroundColor = hex;
            const acc = Math.max(0, Math.round((1 - (m.d / 150)) * 100));
            content.innerHTML = m.recipe.map(i => `<div class="flex justify-between items-center bg-black/40 p-1.5 rounded"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: ${i.c.hex}"></div><span class="text-gray-300 truncate text-[11px]">${i.c.name}</span></div><span class="font-mono text-yellow-500 font-bold text-[11px]">${i.p.toFixed(0)}%</span></div>`).join('') + `<div class="text-[9px] text-right text-yellow-500/70 mt-1">Precisão: ${acc}%</div>`;
        }

        function calculateMixture() {
            if (!targetRGB || (targetRGB.r === 0 && targetRGB.g === 0 && targetRGB.b === 0)) return;
            if (benchColors.length === 0) { document.getElementById('recipeOutput').innerHTML = '<span class="text-red-400 text-[10px] text-center block">Bancada vazia</span>'; return; }
            renderBenchResult(findBestMix(benchColors, targetRGB));
            renderIdealResult(findBestMix(PAINT_COLORS, targetRGB));
        }

        // --- MANIPULAÇÃO DE IMAGEM ---
        document.getElementById('imageInput').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => { const img = new Image(); img.onload = () => { currentImageObject = img; drawImageOnCanvas(); document.getElementById('emptyState').classList.add('hidden'); imageCanvas.classList.remove('hidden'); }; img.src = evt.target.result; };
            reader.readAsDataURL(file);
        });

        function drawImageOnCanvas() {
            const rect = canvasContainer.getBoundingClientRect();
            // Ajusta para densidade de pixel (retina) se necessário, mas mantendo simples para performance
            imageCanvas.width = rect.width; imageCanvas.height = rect.height;
            const scale = Math.min(imageCanvas.width / currentImageObject.width, imageCanvas.height / currentImageObject.height);
            const x = (imageCanvas.width / 2) - (currentImageObject.width / 2) * scale, y = (imageCanvas.height / 2) - (currentImageObject.height / 2) * scale;
            imgState = { x, y, w: currentImageObject.width * scale, h: currentImageObject.height * scale, scale };
            ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, imageCanvas.width, imageCanvas.height);
            ctx.drawImage(currentImageObject, x, y, currentImageObject.width * scale, currentImageObject.height * scale);
        }

        // --- EVENTOS (MOUSE + TOUCH) ---
        function handlePointerMove(clientX, clientY) {
            if (!currentImageObject) return;
            const rect = imageCanvas.getBoundingClientRect(), mouseX = clientX - rect.left, mouseY = clientY - rect.top;
            
            if (mouseX < imgState.x || mouseX > imgState.x + imgState.w || mouseY < imgState.y || mouseY > imgState.y + imgState.h) { 
                magnifier.classList.add('hidden'); return; 
            }
            magnifier.classList.remove('hidden');
            
            // Offset da lupa (para não ficar embaixo do dedo no mobile)
            let magX = clientX + 20, magY = clientY + 20;
            const isMobile = window.innerWidth < 768;
            if (isMobile) { magY = clientY - 140; } // Lupa acima do dedo no mobile

            // Boundary checks
            if (magX + 130 > window.innerWidth) magX = clientX - 140; 
            if (magY + 130 > window.innerHeight) magY = clientY - 140;
            if (magY < 0) magY = clientY + 20;

            magnifier.style.left = `${magX}px`; magnifier.style.top = `${magY}px`;
            
            const realX = (mouseX - imgState.x) / imgState.scale, realY = (mouseY - imgState.y) / imgState.scale;
            zoomCtx.fillStyle = '#000'; zoomCtx.fillRect(0,0,128,128);
            zoomCtx.drawImage(currentImageObject, realX - 21, realY - 21, 42, 42, 0, 0, 128, 128);
        }

        function handlePointerClick(clientX, clientY) {
            if (!currentImageObject) return;
            const rect = imageCanvas.getBoundingClientRect(), mouseX = clientX - rect.left, mouseY = clientY - rect.top;
            if (mouseX < imgState.x || mouseX > imgState.x + imgState.w || mouseY < imgState.y || mouseY > imgState.y + imgState.h) return;
            const p = ctx.getImageData(mouseX, mouseY, 1, 1).data;
            targetRGB = { r: p[0], g: p[1], b: p[2] }; currentTargetHex = rgbToHex(p[0], p[1], p[2]);
            document.getElementById('targetSwatch').style.backgroundColor = currentTargetHex;
            document.getElementById('btnSave').disabled = false;
            calculateMixture();
        }

        // Mouse Events
        canvasContainer.addEventListener('mousemove', (e) => handlePointerMove(e.clientX, e.clientY));
        canvasContainer.addEventListener('click', (e) => handlePointerClick(e.clientX, e.clientY));

        // Touch Events
        canvasContainer.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Previne scroll ao arrastar na imagem
            if(e.touches.length > 0) handlePointerMove(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: false });
        
        canvasContainer.addEventListener('touchstart', (e) => {
             // Inicia lupa imediatamente ao tocar
             if(e.touches.length > 0) handlePointerMove(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: false });

        canvasContainer.addEventListener('touchend', (e) => {
             // Pega a cor ao soltar o dedo
             magnifier.classList.add('hidden');
             if(e.changedTouches.length > 0) handlePointerClick(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        });

        // --- SISTEMA DE SALVAR ---
        function renderSavedRecipes() {
            const s = localStorage.getItem('oil_recipes_v3'); if (s) savedRecipes = JSON.parse(s);
            savedList.innerHTML = savedRecipes.length === 0 ? '<p class="text-[10px] text-gray-700 italic px-2">Vazio.</p>' : savedRecipes.map(r => `<div class="flex items-center justify-between bg-[#09090b] p-2 rounded border border-[#27272a] group"><div class="flex items-center gap-2 cursor-pointer overflow-hidden" onclick="loadRecipe('${r.targetHex}')"><div class="w-6 h-6 rounded border border-gray-600 flex-shrink-0" style="background-color: ${r.targetHex}"></div><span class="text-[11px] text-gray-300 truncate">${r.name}</span></div><button onclick="deleteRecipe(${r.id})" class="text-gray-600 hover:text-red-400 p-1"><i data-lucide="trash" class="w-3 h-3"></i></button></div>`).join('');
            lucide.createIcons();
        }
        window.saveCurrentRecipe = () => { if (!currentTargetHex) return; savedRecipes.unshift({id: Date.now(), name: `Mistura ${savedRecipes.length+1}`, targetHex: currentTargetHex}); localStorage.setItem('oil_recipes_v3', JSON.stringify(savedRecipes)); renderSavedRecipes(); };
        window.deleteRecipe = (id) => { savedRecipes = savedRecipes.filter(r => r.id !== id); localStorage.setItem('oil_recipes_v3', JSON.stringify(savedRecipes)); renderSavedRecipes(); };
        window.loadRecipe = (hex) => { currentTargetHex = hex; targetRGB = hexToRgb(hex); document.getElementById('targetSwatch').style.backgroundColor = hex; calculateMixture(); };

        document.getElementById('searchInput').addEventListener('input', (e) => renderCatalog(e.target.value.toLowerCase()));
        init();
    </script>
</body>
</html>