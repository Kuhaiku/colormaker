<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Misturador Acrilico Pro - Studio v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap');
        
        :root { --app-height: 100dvh; }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #09090b; 
            color: #eee;
            overscroll-behavior: none;
            height: 100vh; 
            height: var(--app-height);
            width: 100vw;
            position: fixed; 
            overflow: hidden;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .checkered-bg {
            background-color: #121212;
            background-image: linear-gradient(45deg, #1a1a1a 25%, transparent 25%), linear-gradient(-45deg, #1a1a1a 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #1a1a1a 75%), linear-gradient(-45deg, transparent 75%, #1a1a1a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        #magnifier { border-radius: 50%; overflow: hidden; box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5), 0 10px 30px rgba(0,0,0,0.8); pointer-events: none; }
        
        /* Estilos para os botões de ferramentas */
        .tool-btn { @apply p-2.5 rounded-lg border border-[#27272a] bg-[#18181b] text-gray-400 transition-all active:scale-95 shadow-lg; }
        .tool-btn.active { @apply bg-orange-600/20 text-orange-500 border-orange-500/50; }
    </style>
</head>
<body class="flex flex-col bg-black">

    <header class="bg-[#09090b] border-b border-[#27272a] h-14 md:h-20 flex-none z-20 flex items-center px-2 md:px-4 shadow-md relative pt-[env(safe-area-inset-top)]">
        <div class="flex items-center gap-2 md:gap-3 w-auto md:w-64 border-r border-[#27272a] mr-2 md:mr-4 pr-2 md:pr-4 h-full py-2">
            <div class="bg-orange-600/20 p-1.5 rounded-lg flex-shrink-0"><i data-lucide="palette" class="w-5 h-5 text-orange-500"></i></div>
            <div class="hidden sm:block">
                <h1 class="text-xs font-bold text-gray-200 uppercase tracking-wider">Catálogo Master</h1>
                <span class="text-[10px] text-gray-500">Tintas a Acrilico</span>
            </div>
        </div>
        <div id="catalogList" class="flex-1 flex gap-1 overflow-x-auto items-center h-full px-2 no-scrollbar touch-pan-x"></div>
        <div class="w-10 md:w-48 ml-1 md:ml-4 pl-1 md:pl-4 md:border-l border-[#27272a] flex justify-end md:justify-start">
            <div class="relative hidden md:block">
                <i data-lucide="search" class="absolute left-2 top-2 w-3 h-3 text-gray-500"></i>
                <input type="text" id="searchInput" class="bg-[#18181b] border border-[#27272a] text-gray-300 text-[10px] rounded-full focus:ring-1 focus:ring-orange-500 block w-full pl-7 p-1.5 placeholder-gray-600" placeholder="Filtrar...">
            </div>
            <button class="md:hidden p-2 text-gray-400" onclick="document.getElementById('searchInput').focus()"><i data-lucide="search" class="w-5 h-5"></i></button>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <section class="flex-1 bg-[#050505] relative flex flex-col items-center justify-center overflow-hidden md:border-r border-[#27272a]">
            
            <div class="absolute top-4 left-4 z-10">
                <input type="file" id="imageInput" accept="image/*" class="hidden">
                <button onclick="document.getElementById('imageInput').click()" class="bg-black/60 hover:bg-zinc-800 text-white px-3 py-2 rounded-lg text-xs font-medium backdrop-blur-md border border-white/10 transition flex items-center gap-2 shadow-lg">
                    <i data-lucide="image-plus" class="w-4 h-4"></i><span class="hidden sm:inline">Carregar</span>
                </button>
            </div>

            <div class="absolute top-4 right-4 z-20 flex gap-2" id="toolbar" style="display: none;">
                <button id="btnToolPicker" onclick="setMode('picker')" class="tool-btn active" title="Conta-Gotas">
                    <i data-lucide="pipette" class="w-5 h-5"></i>
                </button>
                <button id="btnToolMove" onclick="setMode('move')" class="tool-btn" title="Mover e Zoom">
                    <i data-lucide="move" class="w-5 h-5"></i>
                </button>
                <button onclick="resetView()" class="tool-btn" title="Resetar Visualização">
                    <i data-lucide="maximize" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div id="canvasContainer" class="w-full h-full flex items-center justify-center relative checkered-bg touch-none overflow-hidden">
                <div id="emptyState" class="text-center opacity-40 select-none pointer-events-none">
                    <i data-lucide="image" class="w-12 h-12 md:w-16 md:h-16 text-gray-500 mx-auto mb-2"></i>
                    <p class="text-gray-500 text-sm">Carregar imagem</p>
                </div>
                <canvas id="imageCanvas" class="hidden shadow-2xl origin-top-left"></canvas>
                
                <div id="magnifier" class="fixed w-24 h-24 md:w-32 md:h-32 hidden z-50 bg-black border border-gray-700 pointer-events-none">
                    <canvas id="zoomCanvas" width="128" height="128"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center"><div class="w-1 h-1 bg-red-500 shadow-[0_0_2px_white]"></div></div>
                </div>
            </div>

            <div id="modeToast" class="absolute bottom-6 bg-black/70 text-white px-4 py-2 rounded-full text-xs backdrop-blur-md opacity-0 transition-opacity pointer-events-none">
                Modo Conta-Gotas
            </div>
        </section>

        <section class="w-full h-[45%] md:h-full md:w-[400px] flex-none bg-[#0c0c0e] flex flex-col border-t md:border-t-0 md:border-l border-[#27272a] shadow-[0_-4px_20px_rgba(0,0,0,0.5)] z-20 pb-[env(safe-area-inset-bottom)]">
            <div class="flex-1 overflow-y-auto p-3 md:p-5 space-y-3 overscroll-contain">
                
                <div class="bg-[#141417] rounded-xl border border-[#27272a] p-3 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2"><i data-lucide="scan-eye" class="w-3 h-3 text-orange-500"></i> Análise</h3>
                        <div id="accuracyBadge" class="hidden text-[9px] px-1.5 py-0.5 rounded border font-bold bg-gray-800 border-gray-700 text-gray-400">0%</div>
                    </div>
                    
                    <div class="flex items-center gap-3 mb-3">
                        <div class="flex-1">
                            <div id="targetSwatch" class="w-full h-8 rounded border border-gray-700 bg-black shadow-inner"></div>
                            <div class="flex justify-between items-center mt-1">
                                <span class="text-[9px] text-gray-500 uppercase">Alvo</span>
                                <button onclick="saveCurrentRecipe()" id="btnSave" class="text-[9px] bg-zinc-800 hover:bg-zinc-700 text-gray-300 px-2 py-0.5 rounded border border-zinc-700 disabled:opacity-30" disabled>Salvar</button>
                            </div>
                        </div>
                        <i data-lucide="arrow-right" class="text-gray-700 w-4 h-4"></i>
                        <div class="flex-1">
                            <div id="mixedSwatch" class="w-full h-8 rounded border border-gray-700 bg-black shadow-inner"></div>
                            <span class="text-[9px] text-gray-500 uppercase mt-1 block">Mistura</span>
                        </div>
                    </div>
                    
                    <div class="bg-[#09090b] rounded p-2 border border-[#27272a] min-h-[40px] flex flex-col justify-center">
                         <div id="recipeOutput" class="space-y-1"><p class="text-gray-600 italic text-xs text-center">Use o conta-gotas na imagem.</p></div>
                    </div>
                </div>

                <div id="idealMatchContainer" class="hidden relative group">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-yellow-600/20 to-orange-600/20 rounded-xl blur-sm opacity-50"></div>
                    <div class="relative bg-[#141417] rounded-xl p-3 border border-yellow-500/20">
                        <div class="flex justify-between items-start mb-2">
                            <h5 class="text-[10px] font-bold text-yellow-500 uppercase tracking-wider flex items-center gap-1.5"><i data-lucide="sparkles" class="w-3 h-3"></i> Melhor Opção</h5>
                            <div id="idealSwatch" class="w-4 h-4 rounded border border-yellow-500/30 bg-black"></div>
                        </div>
                        <div id="idealMatchContent" class="space-y-1 text-xs"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 md:block md:space-y-4">
                    <div class="bg-[#141417]/50 rounded-lg p-2 border border-[#27272a]/50">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-1"><i data-lucide="box" class="w-3 h-3"></i> Bancada</h3>
                            <button onclick="clearBench()" class="text-[10px] text-red-400 hover:text-red-300 px-1">Limpar</button>
                        </div>
                        <div id="myBench" class="grid grid-cols-1 gap-1 max-h-24 overflow-y-auto pr-1"></div>
                    </div>
                    <div class="bg-[#141417]/50 rounded-lg p-2 border border-[#27272a]/50">
                        <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-2 flex items-center gap-1"><i data-lucide="bookmark" class="w-3 h-3"></i> Salvas</h3>
                        <div id="savedList" class="space-y-1 max-h-24 overflow-y-auto pr-1"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // --- DADOS ---
        const PAINT_COLORS = [
            { id: '319', name: 'Branco Titânio', hex: '#FEFEFE' }, { id: '310', name: 'Carne Clara', hex: '#FBEFD5' },
            { id: '326', name: 'Amarelo Pêssego', hex: '#FAD6A5' }, { id: '342', name: 'Amarelo Nápoles', hex: '#FFDB58' },
            { id: '304', name: 'Amarelo Carne', hex: '#F5D0A9' }, { id: '323', name: 'Amarelo Limão', hex: '#F9F228' },
            { id: '340', name: 'A. Cádmio Claro', hex: '#FFDF00' }, { id: '324', name: 'A. Cádmio', hex: '#FFC000' },
            { id: '302', name: 'Amarelo Escuro', hex: '#FFAB00' }, { id: '339', name: 'Amarelo Indiano', hex: '#E3A857' },
            { id: '360', name: 'Amarelo Ocre', hex: '#C5962B' }, { id: '341', name: 'A. Cádmio Esc.', hex: '#E68A00' },
            { id: '325', name: 'Laranja Cádmio', hex: '#FF7518' }, { id: '335', name: 'Laca Orquídea', hex: '#D48BB6' },
            { id: '316', name: 'Rosa Escuro', hex: '#C74673' }, { id: '315', name: 'Magenta', hex: '#C51D68' },
            { id: '366', name: 'Vermelho Veneza', hex: '#9E3C32' }, { id: '343', name: 'V. Cádmio Claro', hex: '#E34234' },
            { id: '312', name: 'V. Cádmio', hex: '#D3212D' }, { id: '350', name: 'Vermelho Claro', hex: '#D9381E' },
            { id: '344', name: 'V. Cádmio Esc.', hex: '#9E1B32' }, { id: '328', name: 'Laca Gerânio', hex: '#D62B45' },
            { id: '379', name: 'Carmim', hex: '#960018' }, { id: '346', name: 'Alizarin Crimson', hex: '#781F27' },
            { id: '321', name: 'Violeta Cobalto', hex: '#7866B0' }, { id: '330', name: 'Violeta Escuro', hex: '#4B2758' },
            { id: '306', name: 'Azul Hortênsia', hex: '#9FB6CD' }, { id: '363', name: 'Azul Turquesa', hex: '#009DC4' },
            { id: '347', name: 'Azul Cerúleo', hex: '#0077BE' }, { id: '308', name: 'Azul Cobalto', hex: '#0047AB' },
            { id: '348', name: 'Ultramar Claro', hex: '#4666FF' }, { id: '305', name: 'Azul Ftalocianina', hex: '#002366' },
            { id: '331', name: 'Azul da Prússia', hex: '#003153' }, { id: '364', name: 'Verde Inglês 5', hex: '#2E8B57' },
            { id: '322', name: 'Verde Musgo', hex: '#4A5D23' }, { id: '332', name: 'Verde Perm. Esc.', hex: '#00563B' },
            { id: '334', name: 'Verde Oliva', hex: '#6B8E23' }, { id: '354', name: 'Terra Verde', hex: '#6E7F5E' },
            { id: '353', name: 'Verde Vessie', hex: '#395D33' }, { id: '365', name: 'Verde Hooker', hex: '#3B533E' },
            { id: '336', name: 'Terra Siena Nat.', hex: '#A0522D' }, { id: '357', name: 'T. Siena Queimada', hex: '#8A3324' },
            { id: '355', name: 'Sombra Natural', hex: '#5C4033' }, { id: '337', name: 'Marrom Van Dyck', hex: '#45322E' },
            { id: '356', name: 'Sombra Queimada', hex: '#3D2B1F' }, { id: '396', name: 'Sépia', hex: '#2F241E' },
            { id: '311', name: 'Gris Neutro', hex: '#B0B0B0' }, { id: '399', name: 'Gris de Payne', hex: '#536872' },
            { id: '320', name: 'Preto', hex: '#1C1C1C' }
        ];

        let benchColors = [], savedRecipes = [], targetRGB = { r: 0, g: 0, b: 0 }, currentTargetHex = null, currentImageObject = null;
        
        // --- ESTADO DA VISUALIZAÇÃO ---
        let currentMode = 'picker'; // 'picker' ou 'move'
        let transform = { x: 0, y: 0, k: 1 };
        let baseRect = { x: 0, y: 0, w: 0, h: 0, scale: 1 };
        let isDragging = false;
        let lastTouch = { x: 0, y: 0 };
        let startPinchDist = 0;
        let startPinchZoom = 1;

        const catalogList = document.getElementById('catalogList'), myBench = document.getElementById('myBench'), imageCanvas = document.getElementById('imageCanvas');
        const canvasContainer = document.getElementById('canvasContainer'), zoomCanvas = document.getElementById('zoomCanvas'), magnifier = document.getElementById('magnifier');
        const ctx = imageCanvas.getContext('2d'), zoomCtx = zoomCanvas.getContext('2d'), savedList = document.getElementById('savedList');

        function init() {
            renderCatalog(); loadBenchState(); loadSavedRecipes();
            window.addEventListener('resize', () => { 
                document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
                if (currentImageObject) fitImage(); 
            });
            document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
            lucide.createIcons();
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
            return {r,g,b};
        }
        function rgbToHex(r, g, b) { return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase(); }
        function dist(c1, c2) { return Math.sqrt(Math.pow(c1.r - c2.r, 2) + Math.pow(c1.g - c2.g, 2) + Math.pow(c1.b - c2.b, 2)); }

        // --- SISTEMA DE MODOS ---
        window.setMode = (mode) => {
            currentMode = mode;
            document.getElementById('btnToolPicker').className = `tool-btn ${mode === 'picker' ? 'active' : ''}`;
            document.getElementById('btnToolMove').className = `tool-btn ${mode === 'move' ? 'active' : ''}`;
            
            const toast = document.getElementById('modeToast');
            toast.innerText = mode === 'picker' ? 'Modo Conta-Gotas' : 'Modo Mover e Zoom';
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2000);
            
            // Re-render para garantir cursor correto
            if(currentImageObject) draw();
        };

        window.resetView = () => {
            if(!currentImageObject) return;
            transform = { x: 0, y: 0, k: 1 };
            draw();
        };

        // --- CANVAS E IMAGEM ---
        document.getElementById('imageInput').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => { 
                const img = new Image(); 
                img.onload = () => { 
                    currentImageObject = img; 
                    document.getElementById('emptyState').classList.add('hidden'); 
                    imageCanvas.classList.remove('hidden'); 
                    document.getElementById('toolbar').style.display = 'flex';
                    fitImage();
                }; 
                img.src = evt.target.result; 
            };
            reader.readAsDataURL(file);
        });

        function fitImage() {
            const rect = canvasContainer.getBoundingClientRect();
            imageCanvas.width = rect.width; imageCanvas.height = rect.height;
            
            // Calcula escala para caber ("contain")
            const scale = Math.min(imageCanvas.width / currentImageObject.width, imageCanvas.height / currentImageObject.height);
            const w = currentImageObject.width * scale;
            const h = currentImageObject.height * scale;
            const x = (imageCanvas.width - w) / 2;
            const y = (imageCanvas.height - h) / 2;
            
            baseRect = { x, y, w, h, scale };
            transform = { x: 0, y: 0, k: 1 };
            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
            ctx.save();
            
            // Aplica transformações (Pan e Zoom)
            ctx.translate(imageCanvas.width/2, imageCanvas.height/2);
            ctx.scale(transform.k, transform.k);
            ctx.translate(-imageCanvas.width/2 + transform.x, -imageCanvas.height/2 + transform.y);
            
            // Desenha imagem na posição base
            ctx.drawImage(currentImageObject, baseRect.x, baseRect.y, baseRect.w, baseRect.h);
            ctx.restore();

            // Cursor visual para modo Mover
            canvasContainer.style.cursor = currentMode === 'move' ? 'grab' : 'crosshair';
            if(isDragging && currentMode === 'move') canvasContainer.style.cursor = 'grabbing';
        }

        // --- INTERAÇÃO (TOUCH & MOUSE) ---
        function getEventPos(e) {
            if (e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            return { x: e.clientX, y: e.clientY };
        }

        function getDistance(t1, t2) {
            return Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
        }

        // Mouse Down / Touch Start
        function handleStart(e) {
            if (!currentImageObject) return;
            // Se for 2 dedos, inicia Pinch Zoom (apenas modo move)
            if (e.touches && e.touches.length === 2 && currentMode === 'move') {
                isDragging = false;
                startPinchDist = getDistance(e.touches[0], e.touches[1]);
                startPinchZoom = transform.k;
                return;
            }

            const pos = getEventPos(e);
            
            if (currentMode === 'move') {
                isDragging = true;
                lastTouch = pos;
            } else {
                // Modo Picker: Mostra lupa
                handlePickerMove(pos.x, pos.y);
            }
        }

        // Mouse Move / Touch Move
        function handleMove(e) {
            e.preventDefault(); // Importante para não rolar a página
            if (!currentImageObject) return;

            // Pinch Zoom
            if (e.touches && e.touches.length === 2 && currentMode === 'move') {
                const dist = getDistance(e.touches[0], e.touches[1]);
                if (startPinchDist > 0) {
                    const zoomFactor = dist / startPinchDist;
                    // Limita zoom
                    let newK = startPinchZoom * zoomFactor;
                    newK = Math.max(0.5, Math.min(newK, 5));
                    transform.k = newK;
                    draw();
                }
                return;
            }

            const pos = getEventPos(e);

            if (currentMode === 'move' && isDragging) {
                // Pan (Arrastar)
                // Ajusta o delta baseado no zoom atual para parecer natural (ou não, dependendo da preferência)
                // Aqui dividimos pelo zoom para que o arraste acompanhe o dedo
                const dx = (pos.x - lastTouch.x) / transform.k;
                const dy = (pos.y - lastTouch.y) / transform.k;
                transform.x += dx;
                transform.y += dy;
                lastTouch = pos;
                draw();
            } else if (currentMode === 'picker') {
                // Conta-gotas
                handlePickerMove(pos.x, pos.y);
            }
        }

        // Mouse Up / Touch End
        function handleEnd(e) {
            isDragging = false;
            startPinchDist = 0;
            if (currentMode === 'picker') {
                magnifier.classList.add('hidden');
                // Se foi um toque rápido (click), seleciona a cor
                if(e.type !== 'touchcancel') {
                    // Para touch, precisamos pegar a posição do último toque ou do changedTouches
                    let pos;
                    if (e.changedTouches && e.changedTouches.length > 0) {
                        pos = { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
                    } else {
                        pos = { x: e.clientX, y: e.clientY };
                    }
                    pickColor(pos.x, pos.y);
                }
            }
        }

        // Lógica do Conta-Gotas
        function handlePickerMove(clientX, clientY) {
            const rect = imageCanvas.getBoundingClientRect();
            // Verifica limites da tela do canvas
            if (clientX < rect.left || clientX > rect.right || clientY < rect.top || clientY > rect.bottom) {
                magnifier.classList.add('hidden'); return;
            }
            magnifier.classList.remove('hidden');

            // Posiciona Lupa
            let magX = clientX + 20, magY = clientY + 20;
            if (window.innerWidth < 768) { magY = clientY - 140; magX = clientX - 64; } // Mobile topo
            if (magX + 130 > window.innerWidth) magX = window.innerWidth - 140;
            if (magX < 0) magX = 10;
            if (magY < 0) magY = clientY + 40;

            magnifier.style.left = `${magX}px`; magnifier.style.top = `${magY}px`;

            // Matemática reversa para achar o pixel na imagem original
            // 1. Coordenada relativa ao centro do canvas
            const cx = clientX - rect.left - rect.width/2;
            const cy = clientY - rect.top - rect.height/2;
            
            // 2. Remove Pan e Zoom
            const unzoomedX = (cx / transform.k) - transform.x;
            const unzoomedY = (cy / transform.k) - transform.y;
            
            // 3. Coordenada relativa ao Topo-Esquerda do canvas (unzoomed)
            const canvasX = unzoomedX + rect.width/2;
            const canvasY = unzoomedY + rect.height/2;

            // 4. Coordenada dentro da imagem (baseRect)
            const imgX = (canvasX - baseRect.x) / baseRect.scale;
            const imgY = (canvasY - baseRect.y) / baseRect.scale;

            // Desenha na lupa
            zoomCtx.fillStyle = '#000'; zoomCtx.fillRect(0,0,128,128);
            // Validar se está dentro da imagem
            if (imgX >= 0 && imgX <= currentImageObject.width && imgY >= 0 && imgY <= currentImageObject.height) {
                zoomCtx.drawImage(currentImageObject, imgX - 10, imgY - 10, 20, 20, 0, 0, 128, 128);
            }
        }

        function pickColor(clientX, clientY) {
            // Mesma matemática do move para pegar o pixel exato
            const rect = imageCanvas.getBoundingClientRect();
            const cx = clientX - rect.left - rect.width/2;
            const cy = clientY - rect.top - rect.height/2;
            const unzoomedX = (cx / transform.k) - transform.x;
            const unzoomedY = (cy / transform.k) - transform.y;
            const canvasX = unzoomedX + rect.width/2;
            const canvasY = unzoomedY + rect.height/2;
            const imgX = Math.floor((canvasX - baseRect.x) / baseRect.scale);
            const imgY = Math.floor((canvasY - baseRect.y) / baseRect.scale);

            if (imgX >= 0 && imgX < currentImageObject.width && imgY >= 0 && imgY < currentImageObject.height) {
                // Cria canvas temporário para extrair pixel seguro
                const tempC = document.createElement('canvas'); tempC.width = 1; tempC.height = 1;
                const tempCtx = tempC.getContext('2d');
                tempCtx.drawImage(currentImageObject, imgX, imgY, 1, 1, 0, 0, 1, 1);
                const p = tempCtx.getImageData(0, 0, 1, 1).data;
                
                targetRGB = { r: p[0], g: p[1], b: p[2] };
                currentTargetHex = rgbToHex(p[0], p[1], p[2]);
                document.getElementById('targetSwatch').style.backgroundColor = currentTargetHex;
                document.getElementById('btnSave').disabled = false;
                calculateMixture();
            }
        }

        // Listeners
        canvasContainer.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove); // Window para continuar arrastando fora
        window.addEventListener('mouseup', handleEnd);

        canvasContainer.addEventListener('touchstart', handleStart, { passive: false });
        canvasContainer.addEventListener('touchmove', handleMove, { passive: false });
        canvasContainer.addEventListener('touchend', handleEnd);

        // --- MISTURA (Legado) ---
        function findBestMix(colors, target) {
            let best = { d: Infinity, recipe: [], res: { r: 0, g: 0, b: 0 } };
            colors.forEach(c => { const rgb = hexToRgb(c.hex); const d = dist(target, rgb); if (d < best.d) best = { d, recipe: [{ c, p: 100 }], res: rgb }; });
            const sorted = [...colors].sort((a,b) => dist(target, hexToRgb(a.hex)) - dist(target, hexToRgb(b.hex))).slice(0, 4);
            if (sorted.length > 1) {
                for (let w1=0; w1<=10; w1++) {
                    for (let w2=0; w2<=(10-w1); w2++) {
                        for (let w3=0; w3<=(10-w1-w2); w3++) {
                            let w4 = 10-w1-w2-w3;
                            let ws = [w1/10, w2/10, w3/10, w4/10], mix = {r:0,g:0,b:0}, rec = [];
                            ws.forEach((w, i) => { if (w > 0 && sorted[i]) { const rgb = hexToRgb(sorted[i].hex); mix.r += Math.pow(rgb.r, 2)*w; mix.g += Math.pow(rgb.g, 2)*w; mix.b += Math.pow(rgb.b, 2)*w; rec.push({c: sorted[i], p: w*100}); } });
                            mix.r = Math.sqrt(mix.r); mix.g = Math.sqrt(mix.g); mix.b = Math.sqrt(mix.b);
                            const d = dist(target, mix); if (d < best.d) best = { d, recipe: rec, res: mix };
                        }
                    }
                }
            }
            return best;
        }
        function renderBenchResult(m) {
            const hex = rgbToHex(Math.round(m.res.r), Math.round(m.res.g), Math.round(m.res.b));
            document.getElementById('mixedSwatch').style.backgroundColor = hex;
            const acc = Math.max(0, Math.round((1 - (m.d / 150)) * 100));
            const b = document.getElementById('accuracyBadge');
            b.innerText = `${acc}%`; b.classList.remove('hidden');
            b.className = `text-[9px] px-1.5 py-0.5 rounded border font-bold ${acc > 85 ? 'bg-green-900/80 text-green-200 border-green-700' : acc > 60 ? 'bg-yellow-900/80 text-yellow-200 border-yellow-700' : 'bg-red-900/80 text-red-200 border-red-700'}`;
            document.getElementById('recipeOutput').innerHTML = m.recipe.map(i => `<div class="flex justify-between items-center bg-[#18181b] p-1.5 rounded border border-[#27272a]"><div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${i.c.hex}"></div><span class="text-gray-300 truncate w-24 text-[10px]">${i.c.name}</span></div><span class="font-mono text-orange-400 font-bold text-[10px]">${i.p.toFixed(0)}%</span></div>`).join('');
        }
        function renderIdealResult(m) {
            document.getElementById('idealMatchContainer').classList.remove('hidden');
            document.getElementById('idealSwatch').style.backgroundColor = rgbToHex(Math.round(m.res.r), Math.round(m.res.g), Math.round(m.res.b));
            document.getElementById('idealMatchContent').innerHTML = m.recipe.map(i => `<div class="flex justify-between items-center bg-black/40 p-1 rounded"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: ${i.c.hex}"></div><span class="text-gray-300 truncate text-[10px]">${i.c.name}</span></div><span class="font-mono text-yellow-500 font-bold text-[10px]">${i.p.toFixed(0)}%</span></div>`).join('');
        }
        function calculateMixture() {
            if (!targetRGB || (targetRGB.r === 0 && targetRGB.g === 0 && targetRGB.b === 0)) return;
            if (benchColors.length === 0) { document.getElementById('recipeOutput').innerHTML = '<span class="text-red-400 text-[10px] text-center block">Adicione tintas à bancada</span>'; return; }
            renderBenchResult(findBestMix(benchColors, targetRGB));
            renderIdealResult(findBestMix(PAINT_COLORS, targetRGB));
        }
        
        // --- PRODUTOS & BANCADA ---
        function renderCatalog(filter = '') {
            const filtered = PAINT_COLORS.filter(c => c.name.toLowerCase().includes(filter) || c.id.includes(filter));
            catalogList.innerHTML = filtered.map(c => `<div onclick="addToBench('${c.id}')" class="flex-shrink-0 w-8 h-8 rounded-full border-2 border-[#333] hover:border-orange-500 cursor-pointer transition-all active:scale-90 shadow-md" style="background-color: ${c.hex}" title="${c.name}"></div>`).join('');
        }
        function renderBench() {
            if (benchColors.length === 0) { myBench.innerHTML = `<div class="text-center py-2 border border-dashed border-[#27272a] rounded bg-[#09090b]"><p class="text-[9px] text-gray-500">Adicione tintas</p></div>`; } 
            else { myBench.innerHTML = benchColors.map(c => `<div class="flex items-center justify-between bg-[#141417] p-1.5 rounded border border-[#27272a] group"><div class="flex items-center gap-2 overflow-hidden"><div class="w-3 h-3 rounded-full border border-gray-600 flex-shrink-0" style="background-color: ${c.hex}"></div><span class="text-[9px] text-gray-400 truncate w-20">${c.name}</span></div><button onclick="removeFromBench('${c.id}')" class="text-gray-600 hover:text-red-400 p-1"><i data-lucide="x" class="w-3 h-3"></i></button></div>`).join(''); }
            lucide.createIcons(); if (targetRGB.r > 0) calculateMixture();
        }
        window.addToBench = (id) => { if (!benchColors.find(c => c.id === id)) { benchColors.push(PAINT_COLORS.find(c => c.id === id)); saveBenchState(); renderBench(); } };
        window.removeFromBench = (id) => { benchColors = benchColors.filter(c => c.id !== id); saveBenchState(); renderBench(); };
        window.clearBench = () => { benchColors = []; saveBenchState(); renderBench(); };
        function saveBenchState() { localStorage.setItem('oil_bench_v3', JSON.stringify(benchColors.map(c => c.id))); }
        function loadBenchState() { const s = localStorage.getItem('oil_bench_v3'); if (s) { try { const ids = JSON.parse(s); benchColors = PAINT_COLORS.filter(c => ids.includes(c.id)); } catch(e){} } renderBench(); }
        function renderSavedRecipes() { const s = localStorage.getItem('oil_recipes_v3'); if (s) savedRecipes = JSON.parse(s); savedList.innerHTML = savedRecipes.length === 0 ? '<p class="text-[9px] text-gray-700 italic px-2">Vazio.</p>' : savedRecipes.map(r => `<div class="flex items-center justify-between bg-[#09090b] p-1.5 rounded border border-[#27272a] group"><div class="flex items-center gap-2 cursor-pointer overflow-hidden" onclick="loadRecipe('${r.targetHex}')"><div class="w-4 h-4 rounded border border-gray-600 flex-shrink-0" style="background-color: ${r.targetHex}"></div><span class="text-[10px] text-gray-300 truncate w-16">${r.name}</span></div><button onclick="deleteRecipe(${r.id})" class="text-gray-600 hover:text-red-400 p-1"><i data-lucide="trash" class="w-3 h-3"></i></button></div>`).join(''); lucide.createIcons(); }
        window.saveCurrentRecipe = () => { if (!currentTargetHex) return; savedRecipes.unshift({id: Date.now(), name: `Mix ${savedRecipes.length+1}`, targetHex: currentTargetHex}); localStorage.setItem('oil_recipes_v3', JSON.stringify(savedRecipes)); renderSavedRecipes(); };
        window.deleteRecipe = (id) => { savedRecipes = savedRecipes.filter(r => r.id !== id); localStorage.setItem('oil_recipes_v3', JSON.stringify(savedRecipes)); renderSavedRecipes(); };
        window.loadRecipe = (hex) => { currentTargetHex = hex; targetRGB = hexToRgb(hex); document.getElementById('targetSwatch').style.backgroundColor = hex; calculateMixture(); };
        document.getElementById('searchInput').addEventListener('input', (e) => renderCatalog(e.target.value.toLowerCase()));
        init();
    </script>
</body>
</html>